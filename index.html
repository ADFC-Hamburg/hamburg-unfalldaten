<!DOCTYPE html>
<html>
<head>
    <title>Leaflet GeoCsv Filter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4.5/leaflet.css" />
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <!--[if lte IE 8]><link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4.5/leaflet.ie.css" /><![endif]-->
    <link rel="stylesheet" href="css/MarkerCluster.css" />
    <link rel="stylesheet" href="css/MarkerCluster.Default.css" />
    <!--[if lte IE 8]><link rel="stylesheet" href="../dist/MarkerCluster.Default.ie.css" /><![endif]-->
    <link rel="stylesheet" href="css/screen.css" />

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" ></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.4.5/leaflet.js"></script>
    <script src="js/leaflet.markercluster.js"></script>
    <script src="js/leaflet.geocsv.js"></script>
    <script src="config.js"></script>
</head>
<body>

    <div id="map"></div>
    <div id="filter-container">
        <form class="form-search" class="noSelect" onSubmit="addCsvMarkers(); return false;">
            <input type="text" id="filter-string" class="input-medium search-query">
            <button type="submit" class="btn btn-small">Search</button>
        </form>
    </div>

    <script type="text/javascript">

        var baseUrl = 'http://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}.jpg'
            baseAttribution = 'ESRI, National Geographic'
            basemap = new L.TileLayer(baseUrl, {maxZoom: 17, attribution: baseAttribution});

        var center = new L.LatLng(0, 0);

        var map = new L.Map('map', {center: center, zoom: 2, maxZoom: maxZoom, layers: [basemap]});

        var points = L.geoCsv (null, {
            firstLineTitles: true, 
            fieldSeparator: fieldSeparator,
            onEachFeature: function (feature, layer) {
                var popup = '<table class="table table-striped table-bordered table-condensed">';
                for (var clave in feature.properties) {
                    var title = points.getPropertyTitle(clave);
                    popup += '<tr><th>'+title+'</th><td>'+feature.properties[clave]+'</td></tr>';
                }
                popup += "</table>";
                layer.bindPopup(popup);
            },
            filter: function(feature, layer) {
                if (!filterString) {
                    return true;
                }
                var hit = false;
                var lowerFilterString = filterString.toLowerCase(); 
                $.each(feature.properties, function(k, v) {
                    var value = v.toLowerCase();
                    if (value.indexOf(lowerFilterString) !== -1) {
                        hit = true;
                        return false;
                    }
                });
                return hit;
            }
        });

        var filterString;
        var markers = new L.MarkerClusterGroup();
        var dataCsv;

        var addCsvMarkers = function() {
            filterString = document.getElementById('filter-string').value;

            map.removeLayer(markers);
            points.clearLayers();

            markers = new L.MarkerClusterGroup();
            points.addData(dataCsv);
            markers.addLayer(points);

            map.addLayer(markers);
            map.fitBounds(markers.getBounds())
        };

        $.ajax ({
            type:'GET',
            dataType:'text',
            url: dataUrl,
            error: function() {
                alert('Error retrieving csv file');
            },
            success: function(csv) {
                dataCsv = csv;
                addCsvMarkers();
            }
        });

        map.addLayer(markers);
    </script>
</body>
</html>
